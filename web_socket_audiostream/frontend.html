<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Audio Streaming</title>
</head>
<body>
    <button id="startButton">Start Recording</button>
    <button id="stopButton">Stop Recording</button>

    <script>
        let mediaRecorder;
        let socket;
        let audioContext;
        let sourceNode;
        let scriptNode;

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');

        startButton.onclick = startRecording;
        stopButton.onclick = stopRecording;

        function startRecording() {
            socket = new WebSocket('ws://localhost:8765');
            
            socket.onopen = function(e) {
                console.log("WebSocket connection established");
                socket.send("start");

                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        audioContext = new AudioContext();
                        sourceNode = audioContext.createMediaStreamSource(stream);
                        scriptNode = audioContext.createScriptProcessor(4096, 1, 1);

                        sourceNode.connect(scriptNode);
                        scriptNode.connect(audioContext.destination);

                        scriptNode.onaudioprocess = function(audioProcessingEvent) {
                            if (socket.readyState === WebSocket.OPEN) {
                                var inputBuffer = audioProcessingEvent.inputBuffer;
                                var inputData = inputBuffer.getChannelData(0);
                                socket.send(convertFloat32ToInt16(inputData));
                            }
                        };
                    });
            };

            socket.onmessage = function(event) {
                console.log('Message from server:', event.data);
            };
        }

        function stopRecording() {
            if (scriptNode) {
                scriptNode.disconnect();
                sourceNode.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
            if (socket) {
                socket.send("stop");
                socket.close();
            }
        }

        function convertFloat32ToInt16(buffer) {
            var l = buffer.length;
            var buf = new Int16Array(l);
            while (l--) {
                buf[l] = Math.min(1, buffer[l]) * 0x7FFF;
            }
            return buf.buffer;
        }
    </script>
</body>
</html>